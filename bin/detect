#!/bin/bash
# Cloud Foundry PHP Buildpack - Detect Script
# Pure bash implementation matching Ruby/Java buildpack pattern

set -e

BUILD_DIR=$1
BUILDPACK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
VERSION=$(cat "$BUILDPACK_DIR/VERSION" 2>/dev/null || echo "unknown")

# 1. Check for composer.json (most common indicator)
[ -f "$BUILD_DIR/composer.json" ] && echo "php $VERSION" && exit 0

# 2. Check for .php files
compgen -G "$BUILD_DIR/*.php" > /dev/null 2>&1 && echo "php $VERSION" && exit 0

# 3. Check for common web directories with PHP files
for webdir in htdocs public web www; do
  if [ -d "$BUILD_DIR/$webdir" ]; then
    compgen -G "$BUILD_DIR/$webdir/*.php" > /dev/null 2>&1 && echo "php $VERSION" && exit 0
  fi
done

# 4. Check for index.php in subdirectories (common pattern)
[ -f "$BUILD_DIR/htdocs/index.php" ] && echo "php $VERSION" && exit 0
[ -f "$BUILD_DIR/public/index.php" ] && echo "php $VERSION" && exit 0
[ -f "$BUILD_DIR/web/index.php" ] && echo "php $VERSION" && exit 0
[ -f "$BUILD_DIR/www/index.php" ] && echo "php $VERSION" && exit 0

# 5. Check for PHP files recursively (slower, last resort)
if find "$BUILD_DIR" -maxdepth 3 -name "*.php" -type f 2>/dev/null | head -1 | grep -q .; then
  echo "php $VERSION"
  exit 0
fi

# Not a PHP app
exit 1
